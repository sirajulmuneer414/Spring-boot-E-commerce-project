<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragment::head}">
    <title>Admin Dashboard</title>
</head>

<body class="bg-body">

    <!-- Navbar & Sidebar -->
    <div th:replace="~{fragment::admin-navbar}"></div>
    <div th:replace="~{fragment::admin-sidebar}"></div>

    <!-- Main Content -->
    <main class="main-content position-relative" style="margin-top: 20px; transition: 0.5s;">

        <!-- Auth Message Toast -->
        <div th:if="${authMessage}" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"
            id="authToastContainer">
            <div class="toast show align-items-center text-bg-warning border-0 shadow-lg" role="alert"
                aria-live="assertive" aria-atomic="true" id="authToast">
                <div class="d-flex">
                    <div class="toast-body fw-semibold">
                        <i class='bx bx-info-circle me-2'></i>
                        <span th:text="${authMessage}">Message</span>
                    </div>
                    <button type="button" class="btn-close btn-close-dark me-2 m-auto" aria-label="Close"
                        onclick="document.getElementById('authToastContainer').remove()"></button>
                </div>
            </div>
        </div>
        <script>
            setTimeout(function () {
                var el = document.getElementById('authToastContainer');
                if (el) el.remove();
            }, 5000);
        </script>
        <!-- Padding managed by JS in sidebar fragment, but we add initial container styling -->
        <div class="container-fluid py-4 body-pd" id="body-pd">

            <div class="d-flex justify-content-between align-items-center mb-5">
                <div>
                    <h2 class="fw-bold mb-1">Dashboard Overview</h2>
                    <p class="text-secondary mb-0">Welcome back, here's what's happening with your store.</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-white border shadow-sm"><i class='bx bx-filter-alt me-2'></i> Filter</button>
                    <a href="/admin/dashboard/report" target="_blank" class="btn btn-primary-custom shadow-md"><i
                            class='bx bx-printer me-2'></i> Print
                        Report</a>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row g-4 mb-5">
                <!-- Total Sales -->
                <div class="col-xl-4 col-md-6">
                    <div class="card card-custom border-0 h-100 shadow-hover position-relative overflow-hidden">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <p class="text-secondary fw-medium mb-1">Total Sales</p>
                                    <h3 class="fw-bold mb-2" th:text="'₹' + ${totalSales}">₹0</h3>
                                    <span class="badge bg-success-subtle text-success rounded-pill px-2 py-1">
                                        <i class='bx bx-trending-up'></i> +12.5%
                                    </span>
                                </div>
                                <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary">
                                    <i class='bx bx-dollar-circle fs-3'></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sold Products -->
                <div class="col-xl-4 col-md-6">
                    <div class="card card-custom border-0 h-100 shadow-hover position-relative overflow-hidden">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <p class="text-secondary fw-medium mb-1">Products Sold</p>
                                    <h3 class="fw-bold mb-2" th:text="${soldProducts}">0</h3>
                                    <span class="badge bg-primary-subtle text-primary rounded-pill px-2 py-1">
                                        <i class='bx bx-box'></i> Count
                                    </span>
                                </div>
                                <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning">
                                    <i class='bx bx-shopping-bag fs-3'></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Customers -->
                <div class="col-xl-4 col-md-6">
                    <div class="card card-custom border-0 h-100 shadow-hover position-relative overflow-hidden">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <p class="text-secondary fw-medium mb-1">Total Customers</p>
                                    <h3 class="fw-bold mb-2" th:text="${totalCustomers}">0</h3>
                                    <span class="badge bg-info-subtle text-info rounded-pill px-2 py-1">
                                        <i class='bx bx-user-plus'></i> New
                                    </span>
                                </div>
                                <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success">
                                    <i class='bx bx-group fs-3'></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card card-custom border-0 shadow-sm">
                        <div
                            class="card-header bg-white border-0 py-4 px-4 d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <h5 class="fw-bold mb-0">Sales & Revenue Analytics</h5>
                            <div class="btn-group shadow-sm rounded-pill overflow-hidden" role="group">
                                <button type="button"
                                    class="btn btn-outline-light text-dark fw-medium border-0 px-4 active-filter"
                                    id="dailyBtn">Daily</button>
                                <button type="button" class="btn btn-outline-light text-dark fw-medium border-0 px-4"
                                    id="weeklyBtn">Weekly</button>
                                <button type="button" class="btn btn-outline-light text-dark fw-medium border-0 px-4"
                                    id="monthlyBtn">Monthly</button>
                                <button type="button" class="btn btn-outline-light text-dark fw-medium border-0 px-4"
                                    id="yearlyBtn">Yearly</button>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <canvas id="combinedChart" width="400" height="120"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <!-- Chart Logic -->
    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function () {

            // Filter Button Styling
            const filterBtns = document.querySelectorAll('.card-header .btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    filterBtns.forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                        b.classList.add('text-dark');
                    });
                    this.classList.remove('text-dark');
                    this.classList.add('bg-primary', 'text-white');
                });
            });

            // Set initial active
            const dailyBtn = document.getElementById('dailyBtn');
            if (dailyBtn) {
                dailyBtn.classList.add('bg-primary', 'text-white');
                dailyBtn.classList.remove('text-dark');
            }

            // --- Chart Implementation ---
            const ctx = document.getElementById('combinedChart').getContext('2d');
            let combinedChart;

            // Robust Parser
            const parse = (input) => {
                try {
                    if (!input) return {};
                    if (typeof input === 'object') return input;
                    return JSON.parse(input);
                } catch (e) {
                    console.error("Chart Data Parse Error:", e, input);
                    return {};
                }
            };

            // Load Data from Thymeleaf
            const rawData = {
                daily: {
                    sales: parse([[${ dailySales }]]),
                    count: parse([[${ dailyCount }]])
                },
                weekly: {
                    sales: parse([[${ weeklySales }]]),
                    count: parse([[${ weeklyCount }]])
                },
                monthly: {
                    sales: parse([[${ monthlySales }]]),
                    count: parse([[${ monthlySalesCount }]])
                },
                yearly: {
                    sales: parse([[${ yearlySales }]]),
                    count: parse([[${ yearlySalesCount }]])
                }
            };

            console.log("Loaded Chart Data:", rawData);

            function updateChart(period) {
                const dataSet = rawData[period];
                if (!dataSet) {
                    console.warn(`No data for period: ${period}`);
                    return;
                }

                let labels = Object.keys(dataSet.sales);
                let salesData = Object.values(dataSet.sales);
                let countData = Object.values(dataSet.count);

                // Sorting Logic
                // Daily/Weekly: Server sends Present -> Past (newest first). Reversing to show Past -> Present.
                if (period === 'daily' || period === 'weekly') {
                    labels = labels.reverse();
                    salesData = salesData.reverse();
                    countData = countData.reverse();
                }
                // Monthly/Yearly: Server sends Past -> Present (oldest first). No reverse needed.

                if (combinedChart) {
                    combinedChart.destroy();
                }

                combinedChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Revenue (₹)',
                                data: salesData,
                                borderColor: '#4F46E5', // Indigo
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                tension: 0.3,
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Orders Count',
                                data: countData,
                                borderColor: '#10B981', // Emerald
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.3,
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#1F2937',
                                bodyColor: '#4B5563',
                                borderColor: '#E5E7EB',
                                borderWidth: 1,
                                padding: 10
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: true, text: 'Revenue (₹)' },
                                grid: { borderDash: [2, 4], drawBorder: false }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: 'Orders' },
                                grid: { drawOnChartArea: false } // only show grid for left axis
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });
            }

            // Initialize
            updateChart('daily');

            // Bind Events
            document.getElementById('dailyBtn').onclick = () => updateChart('daily');
            document.getElementById('weeklyBtn').onclick = () => updateChart('weekly');
            document.getElementById('monthlyBtn').onclick = () => updateChart('monthly');
            document.getElementById('yearlyBtn').onclick = () => updateChart('yearly');

        });
    </script>
</body>

</html>