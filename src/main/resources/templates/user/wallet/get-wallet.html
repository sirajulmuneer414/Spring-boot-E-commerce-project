<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lenscraft - My Wallet</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;700;800&display=swap"
    rel="stylesheet">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Icons -->
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <!-- Razorpay -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    :root {
      --primary: #4F46E5;
      --primary-dark: #4338ca;
      --success: #10B981;
      --warning: # FDB022;
      --danger: #ef4444;
      --dark: #0F172A;
      --light: #F8FAFC;
      --font-heading: 'Outfit', sans-serif;
      --font-body: 'Inter', sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-body);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding-bottom: 60px;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      font-family: var(--font-heading);
    }

    /* Navbar */
    .navbar {
      backdrop-filter: blur(10px);
      background-color: rgba(255, 255, 255, 0.95);
      padding: 1rem 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    /* Page Header */
    .page-header {
      background: white;
      border-radius: 20px;
      padding: 40px;
      margin: 40px 0 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .page-header h1 {
      font-weight: 800;
      color: var(--dark);
      margin: 0;
    }

    /* Balance Card */
    .balance-card {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      border-radius: 20px;
      padding: 40px;
      color: white;
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
      position: relative;
      overflow: hidden;
    }

    .balance-card::before {
      content: '';
      position: absolute;
      width: 200px;
      height: 200px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      top: -100px;
      right: -100px;
    }

    .balance-icon {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }

    .balance-icon i {
      font-size: 30px;
    }

    .balance-label {
      font-size: 0.95rem;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    .balance-amount {
      font-size: 3rem;
      font-weight: 800;
      font-family: var(--font-heading);
    }

    .btn-add-money {
      background: white;
      color: var(--success);
      border: none;
      padding: 12px 28px;
      border-radius: 10px;
      font-weight: 600;
      margin-top: 20px;
      transition: all 0.3s;
    }

    .btn-add-money:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      color: var(--success);
    }

    /* Transaction Card */
    .transaction-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .transaction-card h3 {
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 24px;
    }

    .transaction-table-wrapper {
      max-height: 450px;
      overflow-y: auto;
      border-radius: 12px;
    }

    .transaction-table-wrapper::-webkit-scrollbar {
      width: 8px;
    }

    .transaction-table-wrapper::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }

    .transaction-table-wrapper::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }

    .table {
      margin: 0;
    }

    .table thead {
      position: sticky;
      top: 0;
      background: var(--light);
      z-index: 1;
    }

    .table th {
      font-weight: 600;
      color: var(--dark);
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
      padding: 16px;
      border: none;
    }

    .table td {
      padding: 16px;
      vertical-align: middle;
      border-bottom: 1px solid #e2e8f0;
    }

    .transaction-type {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .transaction-date,
    .transaction-time {
      color: #64748b;
      font-size: 0.9rem;
    }

    .amount-credit {
      color: var(--success);
      font-weight: 700;
      font-size: 1.1rem;
    }

    .amount-debit {
      color: var(--danger);
      font-weight: 700;
      font-size: 1.1rem;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .empty-state i {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    @media (max-width: 768px) {
      .balance-amount {
        font-size: 2rem;
      }

      .page-header {
        padding: 24px;
      }

      .balance-card,
      .transaction-card {
        padding: 24px;
      }
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <div th:replace="~{fragment::navbar}"></div>

  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <h1><i class='bx bx-wallet me-3'></i>My Wallet</h1>
    </div>

    <div class="row g-4">
      <!-- Balance Card -->
      <div class="col-lg-4">
        <div class="balance-card">
          <div class="balance-icon">
            <i class='bx bx-dollar-circle'></i>
          </div>
          <p class="balance-label">Available Balance</p>
          <h2 class="balance-amount" th:text="'₹' + ${wallet.balance}">₹0</h2>
          <button type="button" class="btn-add-money" data-bs-toggle="modal" data-bs-target="#addMoneyModal">
            <i class='bx bx-plus-circle me-2'></i>Add Money
          </button>
        </div>
      </div>

      <!-- Transaction History -->
      <div class="col-lg-8">
        <div class="transaction-card">
          <h3>Transaction History</h3>

          <div th:if="${transactions != null and !transactions.isEmpty()}" class="transaction-table-wrapper">
            <table class="table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th class="text-end">Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="transaction : ${transactions}">
                  <td>
                    <span class="transaction-type" th:text="${transaction.transactionType}">Type</span>
                  </td>
                  <td>
                    <span class="transaction-date" th:text="${transaction.transactionTime.toLocalDate()}">Date</span>
                  </td>
                  <td>
                    <span class="transaction-time" th:text="${transaction.transactionTime.toLocalTime()}">Time</span>
                  </td>
                  <td class="text-end">
                    <span
                      th:classappend="${transaction.transactionStatus.name() == 'DEBIT' ? 'amount-credit' : 'amount-debit'}"
                      th:text="${transaction.transactionStatus.name() == 'DEBIT' ? '+₹' + transaction.amount : '-₹' + transaction.amount}">
                      ₹0
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div th:if="${transactions == null or transactions.isEmpty()}" class="empty-state">
            <i class='bx bx-receipt'></i>
            <p>No transactions yet</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Money Modal -->
  <div class="modal fade" id="addMoneyModal" tabindex="-1" aria-labelledby="addMoneyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius: 16px; border: none;">
        <div class="modal-header" style="border: none; padding: 24px 24px 0;">
          <h5 class="modal-title fw-bold" id="addMoneyModalLabel">Add Money to Wallet</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="padding: 24px;">
          <form th:action="@{/user/addMoney}" method="post" id="payment-form" onsubmit="paymentStart(event)">
            <div class="mb-3">
              <label for="amount" class="form-label fw-600">Amount (₹)</label>
              <input type="text" class="form-control" id="amount" name="amount" placeholder="Enter amount" required
                oninput="restrictInput(this)" style="padding: 12px; border-radius: 10px; border: 2px solid #e2e8f0;">
            </div>
            <button type="submit" class="btn w-100" style="background: linear-gradient(135deg, var(--success) 0%, #059669 100%); 
                                       color: white; padding: 14px; border-radius: 10px; font-weight: 600;">
              <i class='bx bx-plus-circle me-2'></i>Add Money
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div th:replace="~{fragment::footer}"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <meta name="_csrf" th:content="${_csrf.token}" />
  <script>
    function restrictInput(input) {
      input.value = input.value.replace(/[^0-9]/g, '').replace(/^0+/, '');
    }

    function paymentStart(e) {
      e.preventDefault();
      var amount = document.getElementById("amount").value;
      var csrfToken = $("meta[name='_csrf']").attr("content");

      $.ajax({
        url: '/wallet/createOrder',
        type: 'POST',
        data: { amount: amount },
        dataType: 'json',
        beforeSend: function (xhr) {
          xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken);
        },
        success: function (response) {
          if (response.status == "created") {
            let options = {
              key: response.key, // Use key from backend response
              amount: response.amount,
              currency: "INR",
              name: "Lenscraft",
              description: "Add money to wallet",
              order_id: response.id,
              handler: function (response) {
                document.getElementById("payment-form").submit();
              },
              theme: {
                color: "#4F46E5"
              }
            };
            let rzp = new Razorpay(options);
            rzp.on("payment.failed", function (response) {
              alert("Payment failed. Please try again.");
            });
            rzp.open();
          }
        },
        error: function (xhr, status, error) {
          alert("Error creating order. Please try again.");
          console.error("Error:", error);
        }
      });
    }
  </script>
</body>

</html>